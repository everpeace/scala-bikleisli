<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>com/github/everpeace/BiKleisliSample.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> com.github.everpeace

<span class="keyword">object</span> <a title="object com.github.everpeace.BiKleisliSample" id="9462">BiKleisliSample</a> <span title="ScalaObject" class="delimiter">{</span>

  <span class="keyword">def</span> <a title="(args: Array[String])Unit" id="50316">main</a><span class="delimiter">(</span><a title="Array[String]" id="50318">args</a>:<span title="Array[String]">Array</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>

    <span class="keyword">import</span> scalaz.<a href="http://scalaz.github.com/scalaz/scalaz-2.9.1-6.0.2/doc.sxr/scalaz/Scalaz.scala.html#19350" title="object scalaz.Scalaz">Scalaz</a>._
    <span class="keyword">import</span> scalaz.<a href="http://scalaz.github.com/scalaz/scalaz-2.9.1-6.0.2/doc.sxr/scalaz/Monad.scala.html#18015" title="object scalaz.Monad">Monad</a>._
    <span class="keyword">import</span> scalaz.<a href="http://scalaz.github.com/scalaz/scalaz-2.9.1-6.0.2/doc.sxr/scalaz/Comonad.scala.html#10692" title="object scalaz.Comonad">Comonad</a>._
    <span class="keyword">import</span> com.github.everpeace.<a href="BiKleisli.scala.html#9457" title="object com.github.everpeace.BiKleislis">BiKleislis</a>._
    <span class="keyword">import</span> com.github.everpeace.<a href="DistributiveLaws.scala.html#9472" title="object com.github.everpeace.DistributiveLaws">DistributiveLaws</a>._

    case <span class="keyword">class</span> <a title="class User extends java.lang.Object with ScalaObject with Product with Serializable" id="50491">User</a><a href="#50491" title="ScalaObject" class="delimiter">(</a><a title="String" id="50852">name</a>: <span title="String">String</span><span class="delimiter">)</span>                  <span class="comment">// ユーザ：アクセストークンとして</span>
    case <span class="keyword">class</span> <a title="class Person extends java.lang.Object with ScalaObject with Product with Serializable" id="50607">Person</a><a href="#50607" title="ScalaObject" class="delimiter">(</a><a title="String" id="50697">name</a>: <span title="String">String</span><span class="delimiter">)</span>                <span class="comment">// Person: サンプルエンティティ</span>
    case <span class="keyword">class</span> <a title="class AccessRejectedError extends java.lang.Object with ScalaObject with Product with Serializable" id="50659">AccessRejectedError</a><a href="#50659" title="ScalaObject" class="delimiter">(</a><a title="String" id="51181">message</a>:<span title="String">String</span><span class="delimiter">)</span> <span class="comment">// アクセス拒否エラーメッセージ</span>

    <span class="comment">// サンプル Person レポジトリ</span>
    <span class="keyword">object</span> <a title="object PersonRepository" id="50334">PersonRepository</a> <span title="ScalaObject" class="delimiter">{</span>
      <span class="keyword">def</span> <a title="(s: String)Person" id="50692">search</a><span class="delimiter">(</span><a title="String" id="50695">s</a>: <span title="String">String</span><span class="delimiter">)</span>: <a href="#50607" title="Person">Person</a> = <a href="#50607" title="(name: String)Person">Person</a><span class="delimiter">(</span><a href="#50695" title="String">s</a><span class="delimiter">)</span>
      <span class="keyword">def</span> <a title="(p: Person, s: String)Person" id="50693">update</a><span class="delimiter">(</span><a title="Person" id="50701">p</a>: <a href="#50607" title="Person">Person</a>, <a title="String" id="50702">s</a>: <span title="String">String</span><span class="delimiter">)</span>: <a href="#50607" title="Person">Person</a> = <a href="#50607" title="(name: String)Person">Person</a><span class="delimiter">(</span><a href="#50702" title="String">s</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">type</span> <a title="[X](User, X)" id="50336">AccessTokenComonad</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="50337">X</a><span class="delimiter">]</span> = <span title="(User, X)" class="delimiter">(</span>User, X<span class="delimiter">)</span>                           <span class="comment">//User直積スタンピングコモナド</span>
    <span class="keyword">type</span> <a title="[X]Either[AccessRejectedError,X]" id="50338">AuthorizationErrorMonad</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="50339">X</a><span class="delimiter">]</span> = <span title="Either[AccessRejectedError,X]">Either</span><span class="delimiter">[</span>AccessRejectedError, X<span class="delimiter">]</span> <span class="comment">//エラー直和スタンピングモナド</span>

    <span class="comment">// サンプル操作</span>
    <span class="keyword">val</span> <a title="String =&gt; Person" id="50340">search</a> = <span class="delimiter">(</span>s: <span title="String">String</span><span class="delimiter">)</span> =&gt; <a href="#50334" title="object PersonRepository">PersonRepository</a>.<a href="#50692" title="(s: String)Person">search</a><span class="delimiter">(</span><a href="#50705" title="String">s</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Person =&gt; Person" id="50341">updateMrY</a> = <span class="delimiter">(</span>p: <a href="#50607" title="Person">Person</a><span class="delimiter">)</span> =&gt; <a href="#50334" title="object PersonRepository">PersonRepository</a>.<a href="#50693" title="(p: Person, s: String)Person">update</a><span class="delimiter">(</span><a href="#50707" title="Person">p</a>, <span title="java.lang.String(&quot;Mr.Y&quot;)" class="string">&quot;Mr.Y&quot;</span><span class="delimiter">)</span>

    <span class="comment">// サンプル権限テーブル（どの関数を誰が実行していいかのマップ）</span>
    <span class="keyword">val</span> <a title="Map[ScalaObject,Map[User,Boolean]]" id="50342">authMap</a>: <span title="Map[ScalaObject,Map[User,Boolean]]">Map</span><span class="delimiter">[</span>ScalaObject, Map<span class="delimiter">[</span>User, Boolean<span class="delimiter">]</span><span class="delimiter">]</span>
    = <span title="(elems: (ScalaObject, scala.collection.immutable.Map[User,Boolean])*)scala.collection.immutable.Map[ScalaObject,scala.collection.immutable.Map[User,Boolean]]">Map</span><span class="delimiter">(</span><a href="#50340" title="(x: String =&gt; Person)ArrowAssoc[String =&gt; Person]">search</a>    <span title="(y: scala.collection.immutable.Map[User,Boolean])(String =&gt; Person, scala.collection.immutable.Map[User,Boolean])">-&gt;</span> <span title="(elems: (User, Boolean)*)scala.collection.immutable.Map[User,Boolean]">Map</span><span class="delimiter">(</span><a href="#50491" title="(name: String)User">User</a><span title="(x: User)ArrowAssoc[User]" class="delimiter">(</span><span title="java.lang.String(&quot;bob&quot;)" class="string">&quot;bob&quot;</span><span class="delimiter">)</span> <span title="(y: Boolean)(User, Boolean)">-&gt;</span> <span title="Boolean(true)" class="keyword">true</span>,    <span class="comment">//search は bob, alice 両方OK</span>
                           <a href="#50491" title="(name: String)User">User</a><span title="(x: User)ArrowAssoc[User]" class="delimiter">(</span><span title="java.lang.String(&quot;alice&quot;)" class="string">&quot;alice&quot;</span><span class="delimiter">)</span> <span title="(y: Boolean)(User, Boolean)">-&gt;</span> <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>,
          <a href="#50341" title="(x: Person =&gt; Person)ArrowAssoc[Person =&gt; Person]">updateMrY</a> <span title="(y: scala.collection.immutable.Map[User,Boolean])(Person =&gt; Person, scala.collection.immutable.Map[User,Boolean])">-&gt;</span> <span title="(elems: (User, Boolean)*)scala.collection.immutable.Map[User,Boolean]">Map</span><span class="delimiter">(</span><a href="#50491" title="(name: String)User">User</a><span title="(x: User)ArrowAssoc[User]" class="delimiter">(</span><span title="java.lang.String(&quot;bob&quot;)" class="string">&quot;bob&quot;</span><span class="delimiter">)</span> <span title="(y: Boolean)(User, Boolean)">-&gt;</span> <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span><span class="delimiter">)</span>   <span class="comment">//update は bob だけOK</span>

    <span class="comment">// 操作に対する認可関数(上記権限テーブルを参照するような関数)</span>
    <span class="keyword">def</span> <a title="[X, Y](f: X =&gt; Y)(User, X) =&gt; Boolean" id="50343">authorize</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="50346">X</a>, <a title="&gt;: Nothing &lt;: Any" id="50347">Y</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="X =&gt; Y" id="51030">f</a>: X =&gt; Y<span class="delimiter">)</span>: AccessTokenComonad<span class="delimiter">[</span>X<span class="delimiter">]</span> =&gt; Boolean = <a href="#51033" title="Boolean" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="Boolean" class="delimiter">(</span><a title="User" id="51036">u</a>, <a title="X" id="51037">x</a><span class="delimiter">)</span> =&gt; <a href="#50342" title="Map[ScalaObject,Map[User,Boolean]]">authMap</a>.<span title="(key: ScalaObject, default: =&gt; Map[User,Boolean])Map[User,Boolean]">getOrElse</span><span class="delimiter">(</span><a href="#51030" title="X =&gt; Y">f</a>, <span title="=&gt; scala.collection.immutable.Map.type">Map</span>.<span title="scala.collection.immutable.Map[User,Nothing]">empty</span><span class="delimiter">)</span>.<span title="(key: User, default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><a href="#51036" title="User">u</a>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * 操作に認可チェックをデコレートする。
     * X=&gt;Y がデコレートされると ((User,X)) =&gt; Either[AccessRejectedError,Y] になる。
     * (この下の説明についてはBiKleisliSampleTypeError.scala参照)
     * n-arity functionと n-tuple unary functionは型が違うので注意！！
     * デコレータの戻り値を((User,X)) =&gt; Either[AccessRejectedError,Y]にしてもよいが、その場合は★☆に型パラメータを
     * 明示的に渡してやる必要がある。
     */</span>
    <span class="keyword">def</span> <a title="[X, Y](f: X =&gt; Y)(User, X) =&gt; AuthorizationErrorMonad[Y]" id="50348">withAccessCheck</a><span class="delimiter">[</span><a title="&gt;: Nothing &lt;: Any" id="50351">X</a>, <a title="&gt;: Nothing &lt;: Any" id="50352">Y</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="X =&gt; Y" id="51082">f</a>: X =&gt; Y<span class="delimiter">)</span>: AccessTokenComonad<span class="delimiter">[</span>X<span class="delimiter">]</span> =&gt; AuthorizationErrorMonad<span class="delimiter">[</span>Y<span class="delimiter">]</span> = <a href="#51085" title="AuthorizationErrorMonad[Y]" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="AuthorizationErrorMonad[Y]" class="delimiter">(</span><a title="User" id="51088">u</a>, <a title="X" id="51089">x</a><span class="delimiter">)</span> =&gt; <span title="AuthorizationErrorMonad[Y]" class="keyword">if</span> <span class="delimiter">(</span><a href="#50343" title="(f: X =&gt; Y)(User, X) =&gt; Boolean">authorize</a><span title="(v1: (User, X))Boolean" class="delimiter">(</span><a href="#51082" title="X =&gt; Y">f</a><span class="delimiter">)</span><span title="(_1: User, _2: X)(User, X)" class="delimiter">(</span><a href="#51088" title="User">u</a>, <a href="#51089" title="X">x</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span title="(b: Y)Right[Nothing,Y]">Right</span><span class="delimiter">(</span><a href="#51082" title="(v1: X)Y">f</a><span class="delimiter">(</span><a href="#51089" title="X">x</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
        <span title="(a: AccessRejectedError)Left[AccessRejectedError,Nothing]">Left</span><span class="delimiter">(</span><a href="#50659" title="(message: String)AccessRejectedError">AccessRejectedError</a><span class="delimiter">(</span><a href="#51088" title="User">u</a>.<a href="#50852" title="=&gt; String">name</a> <span title="(x$1: Any)java.lang.String">+</span> <span title="java.lang.String(&quot; is not granted.&quot;)" class="string">&quot; is not granted.&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">// BiKleisli 結合</span>
    <span class="comment">// (Tuple2Comonad, EitherMonadに対するDistributesはDistributiveLawsでimplicitに定義されている)</span>
    <span class="keyword">val</span> <a title="com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,String,Person]" id="50353">searchAndUpdateToMrY</a> = <a href="BiKleisli.scala.html#24887" title="(f: (User, String) =&gt; AuthorizationErrorMonad[Person])(implicit w: scalaz.Comonad[AccessTokenComonad], implicit m: scalaz.Monad[AuthorizationErrorMonad], implicit t: scalaz.Distributes[AccessTokenComonad,AuthorizationErrorMonad])com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,String,Person]">★☆</a><a href="BiKleisli.scala.html#24905" title="(bk: com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,String,Person])scalaz.MAB[[α, β]com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,α,β],String,Person]" class="delimiter">(</a><a href="#50348" title="(f: String =&gt; Person)(User, String) =&gt; AuthorizationErrorMonad[Person]">withAccessCheck</a><span class="delimiter">(</span><a href="#50340" title="String =&gt; Person">search</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="http://scalaz.github.com/scalaz/scalaz-2.9.1-6.0.2/doc.sxr/scalaz/MAB.scala.html#64134" title="(k: com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,Person,Person])(implicit c: scalaz.Category[[α, β]com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,α,β]])com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,String,Person]">&gt;&gt;&gt;</a> <a href="BiKleisli.scala.html#24887" title="(f: (User, Person) =&gt; AuthorizationErrorMonad[Person])(implicit w: scalaz.Comonad[AccessTokenComonad], implicit m: scalaz.Monad[AuthorizationErrorMonad], implicit t: scalaz.Distributes[AccessTokenComonad,AuthorizationErrorMonad])com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,Person,Person]">★☆</a><a href="http://scalaz.github.com/scalaz/scalaz-2.9.1-6.0.2/doc.sxr/scalaz/Comonad.scala.html#121013" title="scalaz.Comonad[[α](User, α)]" class="delimiter">(</a><a href="#50348" title="(f: Person =&gt; Person)(User, Person) =&gt; AuthorizationErrorMonad[Person]">withAccessCheck</a><span class="delimiter">(</span><a href="#50341" title="Person =&gt; Person">updateMrY</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="comment">// alice はupdateが許可されていない。</span>
    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><a href="BiKleisli.scala.html#21878" title="(wa: (User, String))AuthorizationErrorMonad[Person]">searchAndUpdateToMrY</a><span title="(_1: User, _2: java.lang.String)(User, java.lang.String)" class="delimiter">(</span><a href="#50491" title="(name: String)User">User</a><span class="delimiter">(</span><span title="java.lang.String(&quot;alice&quot;)" class="string">&quot;alice&quot;</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot;alice&quot;)" class="string">&quot;alice&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">//Left(AccessRejectedError(&quot;alice is not granted.&quot;))</span>

    <span class="comment">// bob は両方認証成功し、処理成功。</span>
    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><a href="BiKleisli.scala.html#21878" title="(wa: (User, String))AuthorizationErrorMonad[Person]">searchAndUpdateToMrY</a><span title="(_1: User, _2: java.lang.String)(User, java.lang.String)" class="delimiter">(</span><a href="#50491" title="(name: String)User">User</a><span class="delimiter">(</span><span title="java.lang.String(&quot;bob&quot;)" class="string">&quot;bob&quot;</span><span class="delimiter">)</span>, <span title="java.lang.String(&quot;bob&quot;)" class="string">&quot;bob&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">//Right(Person(&quot;Mr.Y&quot;))</span>

    <span class="comment">// BiKleisli は Arrowにもなる</span>
    <span class="keyword">val</span> <a title="com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,String,(Person, Person)]" id="50354">sample_arrow</a> = <a href="BiKleisli.scala.html#24887" title="(f: (User, String) =&gt; AuthorizationErrorMonad[Person])(implicit w: scalaz.Comonad[AccessTokenComonad], implicit m: scalaz.Monad[AuthorizationErrorMonad], implicit t: scalaz.Distributes[AccessTokenComonad,AuthorizationErrorMonad])com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,String,Person]">★☆</a><a href="BiKleisli.scala.html#24905" title="(bk: com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,String,Person])scalaz.MAB[[α, β]com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,α,β],String,Person]" class="delimiter">(</a><a href="#50348" title="(f: String =&gt; Person)(User, String) =&gt; AuthorizationErrorMonad[Person]">withAccessCheck</a><span class="delimiter">(</span><a href="#50340" title="String =&gt; Person">search</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="http://scalaz.github.com/scalaz/scalaz-2.9.1-6.0.2/doc.sxr/scalaz/MAB.scala.html#64157" title="(k: com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,String,Person])(implicit a: scalaz.Arrow[[α, β]com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,α,β]])com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,String,(Person, Person)]">&amp;&amp;&amp;</a> <a href="#50353" title="com.github.everpeace.BiKleisli[AccessTokenComonad,AuthorizationErrorMonad,String,Person]">searchAndUpdateToMrY</a>
    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><a href="BiKleisli.scala.html#21878" title="(wa: (User, String))AuthorizationErrorMonad[(Person, Person)]">sample_arrow</a><span title="(_1: User, _2: java.lang.String)(User, java.lang.String)" class="delimiter">(</span><a href="#50491" title="(name: String)User">User</a><span class="delimiter">(</span><span title="java.lang.String(&quot;bob&quot;)" class="string">&quot;bob&quot;</span><span class="delimiter">)</span>,<span title="java.lang.String(&quot;bob&quot;)" class="string">&quot;bob&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">//Right((Person(&quot;bob&quot;),Person(&quot;Mr.Y&quot;)))</span>
    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><a href="BiKleisli.scala.html#21878" title="(wa: (User, String))AuthorizationErrorMonad[(Person, Person)]">sample_arrow</a><span title="(_1: User, _2: java.lang.String)(User, java.lang.String)" class="delimiter">(</span><a href="#50491" title="(name: String)User">User</a><span class="delimiter">(</span><span title="java.lang.String(&quot;alice&quot;)" class="string">&quot;alice&quot;</span><span class="delimiter">)</span>,<span title="java.lang.String(&quot;bob&quot;)" class="string">&quot;bob&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="comment">//Left(AccessRejectedError(&quot;alice is not granted.&quot;))</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>
        </pre>
    </body>
</html>